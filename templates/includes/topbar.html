{% load i18n %}
{% load common_tags %}
<style>
    .topbar {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        z-index: 1000;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        line-height: 20px;
    }

    .topbar fieldset{
        margin-bottom: 0;
    }

    .topbar h3{
        height: 1em;
        margin: 0;
        line-height: 1em;
        font-size: 24.5px;
    }

    .topbar h3 a {
        height: 26px;
        padding: 4px 0 0 0;
    }

    .topbar-inner {
        background-color: #444;
        background-image: none;
        height: 30px;
        padding: 0;
        webkit-box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25),inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25),inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25),inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .topbar #topbar-logo {
        width: 100px;
        background: transparent url(http://d2e48ltfsb5exy.cloudfront.net/myjobs/logos/myjobs_logo_white_small.png) center left no-repeat;
        text-indent: -9000px;
    }

    .topbar .menu-tabs a,
    .topbar #last-microsite-name {
        border: 1px solid transparent !important;
        background-color: transparent;
        color: #FFF;
        font-weight: bold;
        text-decoration: none;
        padding-top: 4px !important;
        padding-bottom: 5px !important;
    }

    #anchor-logo {
        float: left;
        padding: 0 0 5px 0;
    }

    #anchor-logo:after {
        clear: left;
    }

    #anchor-logo.active {
        background-color: #a95051;
    }

    .topbar #last-microsite-name {
        margin-left: 10px;
    }

    .de-topbar-item {
        display: inline-block;
        float: left;
    }

    .wrapper{
        margin: 0 auto;
        width: 960px;
        display: block;
        position: relative;
    }

    .menu-container {
        float: right;
        width: auto;
    }

    .menu-container > ul,
    .menu-container > a {
        float: left;
    }

    .menu-container > div {
        float: left;
    }

    .menu-container > ul {
        margin: 0;
        color: #FFF;
        font-weight: bold;
    }

    .menu-container > ul > li {
        display: inline;
        position: relative;
        float: left;
        padding: 5px 0;
    }

    .menu-container > ul > li > a {
        padding: 7px 12px;
        text-decoration: none;
        color: #FFF;
        display: inline;
    }

    .menu-container > ul > li:hover > a {
        cursor: pointer;
        background-color: #a95051;
        text-decoration: none;
        border-radius: 0;
        -webkit-border-radius: 0;
    }
    
    .menu-container > ul > li > ul {
        display: none;
        background-color: #666;
        color: #FFF;
        position: absolute;
        top: 29px;
        right: 0;
        width: 250px;
    }

    .menu-container > ul > li:last-of-type > ul {
        right: 0;
    }

    .menu-container > ul > li:hover > ul {
        display: list-item;
    }

    .submenu > li {
        width: 100%;
        border-top: 1px solid #333;
        border-bottom: 1px solid #333;
        box-sizing: border-box;
        font-weight: normal;
    }

    .submenu > li + li {
        border-top: 0;
    }

    div.menu-container ul.submenu > li > a {
        text-decoration: none;
        color: white;
        padding: 4px;
        display: block;
        margin-top: 0;
        border-radius: 0;
        -webkit-border-radius: 0;
    }

    ul.submenu > li > a:hover {
        background-color: #444;
        cursor: pointer;
    }

    .topbar ul {
        list-style: none;
    }

    #nav .main-nav img {
        max-width: none;
        padding-left: 5px;
    }

    .arrow-left {
        float: left;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 15px 20px 15px 0;
        border-color: transparent #FFF transparent transparent;
    }

    .topbar #last-microsite .arrow {
        position: absolute;
        float: left;
        margin-left: 2px;
        border-right: 0;
        border-left: 6px solid #fff;
        margin-top: -15px;
    }

    .topbar #last-microsite {
        margin-top: 6px;
    }

    #pop-menu li {
        margin: 0;
        padding: 0;
        color: #FFF;
    }

    #pop-menu a {
        display: block;
        padding: 4px;
        background: #666;
        border-top: 1px solid #333;
        text-decoration: none;
    }

    #pop-menu a.no-show {
        display: none;
    }

    #nav.active li ul#pop-menu {
        display: block;
        text-align: left;
    }

    #logged-in-li {
        padding: 4px !important;
    }

    #back-btn {
        border-right: 1px solid #FFF !important;
        height: 100% !important;
    }

    #back-btn-li {
        float: left;
        width: 40px !important;
        height: 100%;
        z-index: 999;
    }

    .sub-nav-item {
        margin-left: 40px;
    }

    #pop-menu .desktop_hide {
        display: none;
    }

    .submenu-dropdown {
        background-color: #444;
    }

    .submenu-dropdown > a:after {
        float: right;
        display: block;
        width: 0;
        border: 4px solid transparent;
        border-left: 6px solid #999;
        border-right: 0;
    }

    .submenu-dropdown > ul {
        display: none;
        margin: 0;
    }

    .submenu-dropdown ul li {
        padding: 0 10px 0 10px;
    }

    .submenu-dropdown ul li a,
    .submenu-dropdown ul li a:hover {
        color: #fff;
        text-decoration: none;
        font-size: 0.9em;
        line-height: 12px;
        margin-top: 0;
        padding: 0;
    }

    .submenu-dropdown ul li a:hover {
        background-color: #222;
        border-radius: 0;
        -webkit-border-radius: 0;
    }

    .submenu-dropdown ul li:hover {
        background-color: #222;
    }

    #nav.active ul#pop-menu li a:hover,
    #nav li:hover ul#pop-menu li a:hover {
        background:#444;
        color: #fff;
        text-decoration:none;
    }

    .no-show {
        display: none;
    }

    #nav ul#pop-menu {
        background:#444;
        padding: 0;
        margin: 2px 0 0 -2px;
        position:absolute;
        display: none;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        width: 275px;
    }

    #nav a {
        color: #fff;
    }

    #nav > li {
        padding: 5px 2px 3px 2px;
    }

    .menu-container > .desktop_hide {
        display: none;
    }

    @media screen and (max-width: 992px) {
        .wrapper {
            width: 100%;
            margin: 0 auto;
        }

        .menu-container > .mobile_hide {
            display: none;
        }

        .menu-container > .desktop_hide {
            display: block;
        }

        #logo-block {
            margin-top: 10px;
        }

        .topbar #nav .arrow {
            display: none;
        }

        .topbar .gravatar-blank,
        .topbar #nav img {
            display: none;
        }

        #topbar-back {
            position: absolute;
            right: 70px;
            top: 10px;
            padding: 13px;
            background-color: #a95051;
            border: 2px solid #FFF;
            border-radius: 5px;
        }

        #topbar-back #prm-arrow-left{
            width: 0;
            height: 0;
            border-bottom: 10px solid transparent;
            border-top: 10px solid transparent;
            border-right: 15px solid #2f2f2f;
            font-size: 0;
            line-height: 0;
            display: block;
        }

        #topbar-back > #prm-arrow-left {
            border-right: 15px solid #FFF;
        }

        #nav .main-nav {
            background: #a95051 url(http://d2e48ltfsb5exy.cloudfront.net/content_mj/files/images/superbutton.png) no-repeat;
            position: absolute;
            right: 10px;
            top: 10px;
            width: 45px;
            height: 45px;
            padding: 0;
            text-indent: -9000px;
            z-index: 101;
            border: 2px solid #FFF;
            border-radius: 4px;
            cursor: pointer;
        }

        .topbar li a {
            border-width: 1px;
            border-style: solid;
        }

        .topbar-inner {
            background: #444;
            height: 50px;
            border-bottom: 20px solid #a95051;
        }

        #topbar-login form {
            display: none;
        }

        .section #nav {
            display: none;
        }

        #topbar-login #nav.active + form,
        #topbar-login #nav:hover + form {
            background:#444;
            padding: 10px 0 10px 0;
            margin: 3px 0 0 0;
            position:absolute;
            top: 0;
            left: 0;
            display: block;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            width: 100%;
        }

        .topbar #topbar-login input {
            height: 30px;
         }

        .topbar #topbar-login button {
            margin-right: 70px;
            padding: 10px 25px 9px 25px;
        }

        .topbar #nav ul#pop-menu {
            border-top: 20px solid #a95051;
            position: fixed;
            left: 0;
            width: 100%;
            top: 0;
            bottom: 0;
            z-index: 100;
            margin: 0 -10px 0 0;
        }

        .topbar #nav ul#pop-menu li {
            display: block;
            margin: 0;
            width: 100%;
        }

        .topbar #nav ul#pop-menu li.no-show {
            display: none;
        }

        .topbar #nav ul#pop-menu li a {
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
            border-left: 0;
            border-right: 0;
            font-size: 2em;
            height: 25px;
            padding: 10px;
        }

        #pop-menu {
            height: 100%;
        }

        #pop-menu .desktop_hide {
            display: block;
        }
    }
    @media screen and (min-width: 993px) {
        #nav ul#pop-menu {
            right: 0;
        }

        #profile-link,
        #savedsearch-link,
        #candidate-link,
        #partner-link,
        #settings-link {
            display: none !important;
        }

        #account-link, #logout-link {
            display: block;
        }

        .topbar ul {
            position: relative;
        }

        #nav li:hover ul#pop-menu {
            display: block;
            text-align: left;
        }
    }
</style>
<div class="topbar" data-dropdown="dropdown" role="menubar">
    <div class="topbar-inner">
        <div id="de-topbar-content" class="wrapper" {% if from_ajax %}style="margin:0 auto; width:960px; display:block;"{% endif %}>
            <div id="logo-block" class="de-topbar-item">
                <a id="anchor-logo" href="http://www.my.jobs/">
                    <h3 id="topbar-logo">My.jobs</h3>
                </a>
            </div>

            <div id="last-microsite" class="de-topbar-item">
                <a href="{% get_ms_url %}">
                    <span id="last-microsite-name">
                        {% get_ms_name as microsite_name %}
                        {% if microsite_name != None %}
                        {{ microsite_name }}
                        {% endif %}
                    </span>
                    <span class="arrow pull-left"></span>
                </a>
            </div>

            <div class="menu-container" role="menu">
                {% if user.is_authenticated %}
                <ul class="mobile_hide">
                    {% is_a_group_member user "Employer" as group_member %}
                    {% get_company_name user as company_name %}
                    {% if group_member %}
                    <li class="{% active_tab 'employer-tools' %}">
                        <a>{% trans "Employers" %}</a>
                        <ul id="employer-apps" class="submenu">
                            <li><a id="candidate-tab" href="https://secure.my.jobs/candidates/view?company={{ company_name.0.id }}">{% trans "Candidates" %}</a></li>
                            <li><a id="partner-tab" href="https://secure.my.jobs/prm/view?company={{ company_name.0.id }}">{% trans "PRM" %}</a></li>
                        </ul>
                    </li>
                    {% endif %}
                    <li>
                        <a>{{ user.email }}</a>
                        <ul class="submenu">
                            <li><a>{% trans "My Profile" %}</a></li>
                            <li><a>{% trans "My Saved Searches" %}</a></li>
                            <li><a href="https://secure.my.jobs/account/edit">{% trans "Account Settings" %}</a></li>
                            <li><a href="{% get_ms_url %}">{% trans "Search Jobs" %}</a></li>
                            <li><a href="https://secure.my.jobs/accounts/logout">Log Out</a></li>
                        </ul>
                    </li>
                </ul>

                <a id="topbar-back" class="desktop_hide" href="#" onclick="javascript:window.history.back(-1);return false;"><span id="prm-arrow-left"></span></a>
                <div id="" class="menu-bar desktop_hide" style="text-align: right;">
                    <ul id="nav">
                        <li>
                            <a class="main-nav"></a>
                            <ul class="span4" id="pop-menu">
                                <li id="logged-in-li">
                                    {% trans "Logged in as " %}
                                    <b>

                                        {% with short_email=user.email|truncatechars:"20" %}

                                        {% with name_obj=user.get_full_name %}

                                        {% if not name_obj %}

                                        {{ short_email }}

                                        {% else %}

                                        {{ name_obj }}

                                        {% endif %}

                                        {% endwith %}

                                        {% endwith %}

                                    </b>
                                </li>
                                <li id="back-btn-li" class="no-show"><a id="back-btn"><span class="arrow-left"></span></a></li>

                                {% if not user.is_disabled %}
                                    <li><a id="profile-link" class="no-show seeker-menu" href="https://secure.my.jobs/profile/view/">{% trans "My Profile" %}</a></li>

                                    {% if user.is_active %}

                                        <li><a id="savedsearch-link" class="no-show seeker-menu" href="https://secure.my.jobs/saved-search/view/">{% trans "My Saved Searches" %}</a></li>

                                        {% if group_member and user.is_active  %}

                                            <li><a id="employer-tools" class="no-show desktop_hide" style="cursor: pointer;">{% trans "Employer" %}</a></li>

                                            <li><a id="candidate-link" class="no-show sub-nav-item employer-menu" href="https://secure.my.jobs/candidates/view?company={{ company_name.0.id }}">{% trans "Candidates" %}</a></li>

                                            <li><a id="partner-link" class="no-show sub-nav-item employer-menu" href="https://secure.my.jobs/prm/view?company={{ company_name.0.id }}">{% trans "PRM" %}</a></li>

                                        {% endif %}
                                    {% endif %}
                                    <li><a id="account-link" href="https://secure.my.jobs/account/edit">{% trans "Account Settings" %}</a></li>
                                    <li><a id="search-jobs" href="{% get_ms_url %}">{% trans "Search Jobs" %}</a></li>
                                    <li><a id="settings-link" style="cursor: pointer;">{% trans "Settings" %}</a></li>

                                {% endif %}

                                <li><a id="logout-link" href="https://secure.my.jobs/account/logout/">Log Out</a></li>

                                <li><a class="settings-nav-item sub-nav-item no-show" href="https://secure.my.jobs/account/edit">{% trans "Account Settings" %}</a></li>
                                <li><a class="settings-nav-item sub-nav-item no-show" href="https://secure.my.jobs/account/logout">Log Out</a></li>
                            </ul>{# /pop-menu #}
                        </li>
                    </ul>{# /nav #}
                </div>{# /menu-bar pagination-right pull-right #}
                {% else %}
                    {# MOBILE VIEW #}
                    <ul class="mobile_hide">
                        <li><a href="http://www.my.jobs/employers/">{% trans "Employers / Post Jobs" %}</a></li>
                        <li><a href="https://secure.my.jobs">{% trans "Create a Profile" %}</a></li>
                        <li><a href="https://secure.my.jobs">{% trans 'Login' %}</a></li>
                    </ul>
                    <a id="topbar-back" class="desktop_hide" href="#" onclick="javascript:window.history.back(-1);return false;"><span id="prm-arrow-left"></span></a>
                    <div id="" class="menu-bar desktop_hide" style="text-align: right;">
                        <ul id="nav">
                            <li>
                                <a class="main-nav"></a>
                                <ul id="pop-menu">
                                    <li><a id="demo-link" class="no-show" href="http://www.my.jobs/employers/">{% trans "Employers / Post Jobs" %}</a></li>
                                    <li><a id="create-profile" class="no-show" href="https://secure.my.jobs">{% trans "Create a Profile" %}</a></li>
                                    <li><a id="login-link" class="no-show" href="https://secure.my.jobs">{% trans 'Login' %}</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    window.onload = function() {
        /* Explicit control of main menu, primarily for mobile but also provides
        non hover and cover option if that becomes an issue. */
        $(function() {
            $(".main-nav").click(function(e){
                e.preventDefault();
                if($(window).width() < 994){
                    $("#nav").toggleClass("active");
                    $(".company-nav-item").addClass("no-show");
                    $(".settings-nav-item").addClass("no-show");
                    $(".employer-menu").addClass("no-show");
                    $("#back-btn-li").addClass("no-show");
                    $("#account-link").addClass("no-show");
                    $("#logout-link").addClass("no-show");
                    $("#logged-in-li").addClass("no-show");

                    $("#mobile-company-select").removeClass("no-show");
                    $(".seeker-menu").removeClass("no-show");
                    $("#employer-tools").removeClass("no-show");
                    $("#search-jobs").removeClass("no-show");
                    $('#settings-link').removeClass("no-show");

                    //Not logged in mobile view
                    $("#demo-link").removeClass("no-show");
                    $("#create-profile").removeClass("no-show");
                    $("#login-link").removeClass("no-show");
                }
            });

            $("#pop-menu").mouseleave(function(){
                $("#back-btn-li").addClass("no-show");

                $("#account-link").removeClass("no-show");
                $("#logout-link").removeClass("no-show");
                $("#search-jobs").removeClass("no-show");
                $("#logged-in-li").removeClass("no-show");
                $("#nav").removeClass("active");
            });

            $("#employer-tools").click(function(e) {
                $("#back-btn-li").removeClass("no-show");
                $(".employer-menu").removeClass("no-show");

                $(".seeker-menu").addClass("no-show");
                $("#mobile-company-select").addClass("no-show");
                $("#settings-link").addClass("no-show");
                $("#search-jobs").addClass("no-show");
                $("#job-tools").addClass("no-show");
                $("#employer-tools").addClass("no-show");
            });

            $('#settings-link').click(function(e) {
                $(".settings-nav-item").removeClass("no-show");
                $("#back-btn-li").removeClass("no-show");

                $("#mobile-company-select").addClass("no-show");
                $("#settings-link").addClass("no-show");
                $("#job-tools").addClass("no-show");
                $("#employer-tools").addClass("no-show");
                $("#search-jobs").addClass("no-show");
                $("#profile-link").addClass("no-show");
                $("#savedsearch-link").addClass("no-show");
                $("#candidate-link").addClass("no-show");
                $("#partner-link").addClass("no-show");
                $("#account-link").addClass("no-show");
            });

            $("#back-btn").click(function(e){
                e.preventDefault();

                $(".company-nav-item").addClass("no-show");
                $(".partner-nav-item").addClass("no-show");
                $(".settings-nav-item").addClass("no-show");
                $(".employer-menu").addClass("no-show");
                $("#back-btn-li").addClass("no-show");
                $(".multiple_companies").addClass("no-show");

                $(".seeker-menu").removeClass("no-show");
                $("#mobile-company-select").removeClass("no-show");
                $("#job-tools").removeClass("no-show");
                $("#employer-tools").removeClass("no-show");
                $("#search-jobs").removeClass("no-show");
                $("#settings-link").removeClass("no-show");
            });
        });

        {% if group_member and company_name|length > 1 %}
        // See if a cookie is already set. If so update employer links.
        var cid = read_cookie();
        if(cid)
            update_employer_tools(cid);

        // Build multiple company selector
        get_companies();
    };

    function get_companies() {
        {% json_companies company_name as companies %}
        var data = {{ companies|safe }};
        var parent_list_item = document.createElement("li");
        parent_list_item.setAttribute("id", "current-company");
        parent_list_item.setAttribute("class", "submenu-dropdown");

        parent_list_item.onclick = function(event) {
            event.preventDefault();
            var li_last_child = parent_list_item.lastChild;

            if (li_last_child.currentStyle ? li_last_child.currentStyle.display : getComputedStyle(li_last_child, null).display === "none")
                li_last_child.style.display = "block";
            else
                li_last_child.style.display = "none";
        };

        var label = document.createElement("a");

        // Company id from myjobs_company cookie
        var cid = read_cookie();

        var list = document.createElement("ul");
        list.setAttribute("id", "select_company");

        // Company name used to show user what current company is selected
        var menu_company_name;

        // Creating li items for "list" (the ul)
        for(var i=0; i<data.length; i++) {
            // Get company name from cid, if cid exists
            if(!menu_company_name) {
                if(cid) {
                    if(data[i].id == cid)
                        menu_company_name = data[i].name;
                }
                else {
                    set_cookie(data[0].id, 14);
                    menu_company_name = data[0].name;
                }
            }
            var list_item = document.createElement("li");
            list_item.setAttribute("id", "company_" + String(data[i].id));
            list_item.innerHTML = "<a>"+data[i].name+"</a>";
            list_item.onclick = function() {
                // this.id Format: company_COMPANYID
                var item_id = this.id.split("_")[1];

                // 14 = 2 weeks
                set_cookie(item_id, 14);

                // replaces text of main li holding company list
                parent_list_item.firstChild.innerHTML = "Currently <b>"+ this.firstChild.innerHTML +"</b>";

                update_employer_tools(item_id);
            };
            list.appendChild(list_item);
        }
        label.innerHTML = "Currently <b>"+ menu_company_name +"</b>";
        parent_list_item.appendChild(label);
        parent_list_item.appendChild(list);

        var parent_element = document.getElementById("employer-apps");
        var first_child = parent_element.firstChild;
        parent_element.insertBefore(parent_list_item, first_child);

        // Mobile
        var mobile_parent_element = document.createElement("li");
        mobile_parent_element.setAttribute("id", "mobile-company-select");
        mobile_parent_element.setAttribute("class", "no-show");
        var mobile_label = document.createElement("a");
        mobile_label.innerHTML = "Currently <b>" + menu_company_name + "</b>";
        mobile_parent_element.appendChild(mobile_label);
        mobile_parent_element.onclick = function() {
            $(".multiple_companies").removeClass("no-show");
            $("#back-btn-li").removeClass("no-show");

            $("#mobile-company-select").addClass("no-show");
            $("#settings-link").addClass("no-show");
            $("#job-tools").addClass("no-show");
            $("#employer-tools").addClass("no-show");
            $("#search-jobs").addClass("no-show");
            $("#profile-link").addClass("no-show");
            $("#savedsearch-link").addClass("no-show");
            $("#candidate-link").addClass("no-show");
            $("#partner-link").addClass("no-show");
            $("#account-link").addClass("no-show");
        };
        var pop_menu = document.getElementById("pop-menu");
        var search_item = document.getElementById("search-jobs");
        pop_menu.insertBefore(mobile_parent_element, search_item.parentNode);

        for(var j=0; j<data.length; j++) {
            var mobile_list_item = document.createElement("li");
            mobile_list_item.setAttribute("id", "mobilecompany_" + data[j].id);
            mobile_list_item.setAttribute("class", "no-show sub-nav-item multiple_companies");
            mobile_list_item.setAttribute("style", "cursor:pointer");
            mobile_list_item.innerHTML = "<a>"+ data[j].name +"</a>";
            mobile_list_item.onclick = function() {
                var mobile_item_id = this.id.split("_")[1];
                set_cookie(mobile_item_id, 14);
                mobile_parent_element.firstChild.innerHTML = "Currently <b>"+ this.firstChild.innerHTML + "</b>";
                update_employer_tools(mobile_item_id);
                $("#back-btn").click();
            };
            pop_menu.appendChild(mobile_list_item);
        }
    }

    function set_cookie(company_id, days) {
        var expires;
        if(days) {
            var date = new Date();
            date.setTime(date.getTime()+(days*24*60*60*1000));
            expires = "; expires="+date.toGMTString();
        } else
            expires = "";
        document.cookie = "myjobs_company="+company_id+expires+"; path=/";
    }

    function read_cookie() {
        var nameEQ = "myjobs_company=";
        var ca = document.cookie.split(';');
        for (var i=0; i< ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ')
                c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0)
                return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function delete_cookie() {
        set_cookie("", -1);
    }

    function update_employer_tools(company_id) {
        // li_children are children of Employer Tools
        var li_children = document.getElementById("employer-apps").children;

        // Editing links from old company to newly set company
        for(var i=0; i<li_children.length; i++)
            li_children[i].firstChild.search = "company="+company_id;

        var candidate_link = document.getElementById("candidate-link");
        candidate_link.search = "company=" + company_id;

        var partner_link = document.getElementById("partner-link");
        partner_link.search = "company=" + company_id;
    }

    {% else %}
    }
    {% endif %}
</script>
